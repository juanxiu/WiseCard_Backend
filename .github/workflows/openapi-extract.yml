name: openapi-extract and diff with prod
on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
    types: [ closed ]

jobs:
  build-prod:
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:7
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main # prod

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Generate OpenAPI spec
        run: ./gradlew clean generateOpenApiDocs

        env:
          APP_API_KAKAO_KEY: ${{ secrets.APP_API_KAKAO_KEY }}
          REDIS_HOST: localhost
          REDIS_PORT: 6379

      - uses: actions/upload-artifact@v4 # ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        with:
          name: prod-spec
          path: build/openapi.json

      - name: Swagger UI Action
        uses: Legion2/swagger-ui-action@v1.3.0
        with:
          output: swagger-ui
          spec-file: build/openapi.json
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3  #gp-pages ë¸Œëœì¹˜ rootì— swagger-ui push
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: swagger-ui
          publish_branch: main   # ë°°í¬ ëŒ€ìƒ ë¸Œëœì¹˜
          destination_dir: ''    # ë¸Œëœì¹˜ ë£¨íŠ¸ì— ë°°í¬

  build-dev:
    needs: build-prod # ì‹¤í–‰ ìˆœì„œ ë³´ì¥
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: feat/#2-grpc-module  # dev ë¡œ ë³€ê²½í•  ê²ƒ

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Generate OpenAPI spec
        run: ./gradlew clean generateOpenApiDocs

      - uses: actions/download-artifact@v4 # ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        with:
          name: prod-spec
          path: ./prod

      - name: List downloaded prod artifact files # ê²½ë¡œ í™•ì¸
        run: ls -R ./prod


      - name: Run openapi-diff with docker # ë„ì»¤ í—ˆë¸Œì—ì„œ ì´ë¯¸ì§€ ì‚¬ìš©
        run: docker run --rm -v ${{ github.workspace }}:/specs openapitools/openapi-diff:latest /specs/prod/openapi.json /specs/build/openapi.json --json /specs/diff.json

      - name: Show diff result
        run: cat diff.json

      - name: Send custom Discord Notification from diff.json
        uses: actions/github-script@v6
        env:
          SWAGGER_DISCORD_WEBHOOK: ${{ secrets.SWAGGER_DISCORD_WEBHOOK }}
        with:
          script: |
            const fs = require('fs');

            const diff = JSON.parse(fs.readFileSync('diff.json', 'utf8'));

            // newEndpoints ê¸°ë°˜ ë©”ì‹œì§€ í¬ë§·íŒ… í•¨ìˆ˜
            function formatNewEndpoints(endpoints) {
              if (!endpoints || endpoints.length === 0) return "âš ï¸ ë³€ê²½ëœ ìƒˆë¡œìš´ ì—”ë“œí¬ì¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.\n";

              let msg = "**ğŸ†• ìƒˆë¡œìš´ ì—”ë“œí¬ì¸íŠ¸ ëª©ë¡:**\n";
              endpoints.forEach(ep => {
                const path = ep.pathUrl || 'unknown path';
                const methods = Object.keys(ep.path || {}).join(', ').toUpperCase() || 'N/A';
                const tags = (ep.path && Object.values(ep.path)[0]?.tags) ? Object.values(ep.path)[0].tags.join(', ') : 'No tags';
                msg += `- ê²½ë¡œ: \`${path}\`\n  ë©”ì„œë“œ: ${methods}\n  íƒœê·¸: ${tags}\n\n`;
              });
              return msg;
            }

            let message = '**OpenAPI ë³€ê²½ ì•Œë¦¼**\n\n';
            message += formatNewEndpoints(diff.newEndpoints);

            // ì¶”í›„ missingEndpoints, changedOperations ë“±ë„ ë¹„ìŠ·í•˜ê²Œ ì¶”ê°€ ê°€ëŠ¥

            const webhookUrl = process.env.SWAGGER_DISCORD_WEBHOOK;
            await fetch(webhookUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ content: message }),
            });




